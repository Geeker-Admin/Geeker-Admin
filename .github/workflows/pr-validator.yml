name: PR Validator

on:
  pull_request:
    types: [opened, edited, synchronize]

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Format
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            let validationErrors = [];

            // æ£€æŸ¥æ˜¯å¦å…³è”äº† issue
            const hasIssueLink = body.includes('**å…³è” Issue:** #') && !body.includes('**å…³è” Issue:** #_____');
            if (!hasIssueLink) {
              validationErrors.push('âŒ å¿…é¡»å…³è”ä¸€ä¸ª issueï¼ˆæ ¼å¼ï¼š#issue_numberï¼‰');
            }

            // æ£€æŸ¥æ˜¯å¦åªæœ‰ä¸€ä¸ª commit
            if (commits.data.length > 1) {
              validationErrors.push('âŒ PR åªèƒ½åŒ…å«ä¸€ä¸ª commitï¼Œè¯·ä½¿ç”¨ rebase åˆå¹¶å¤šä¸ª commit');
            }

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº† PR ç±»å‹
            const validTypes = [
              'feat', 'fix', 'docs', 'style', 'refactor', 'perf', 'test', 
              'build', 'ci', 'chore', 'revert', 'wip', 'workflow', 'types', 'release'
            ];

            const hasPRType = body.includes('- [x]') && validTypes.some(type => {
              const typeMap = {
                'feat': 'âœ¨ æ–°åŠŸèƒ½',
                'fix': 'ğŸ› Bug ä¿®å¤', 
                'docs': 'ğŸ“ æ–‡æ¡£æ›´æ–°',
                'style': 'ğŸ¨ ä»£ç é‡æ„',
                'refactor': 'ğŸ¨ ä»£ç é‡æ„',
                'perf': 'âš¡ æ€§èƒ½ä¼˜åŒ–',
                'test': 'âœ… æµ‹è¯•ç›¸å…³',
                'build': 'ğŸ”§ æ„å»º/CI ç›¸å…³',
                'ci': 'ğŸ”§ æ„å»º/CI ç›¸å…³',
                'chore': 'ğŸ”§ æ„å»º/CI ç›¸å…³',
                'revert': 'ğŸ”„ å›æ»š',
                'wip': 'ğŸš§ å¼€å‘ä¸­',
                'workflow': 'ğŸ”§ æ„å»º/CI ç›¸å…³',
                'types': 'ğŸ”§ æ„å»º/CI ç›¸å…³',
                'release': 'ğŸš€ å‘å¸ƒç›¸å…³'
              };
              return body.includes(typeMap[type]);
            });
            if (!hasPRType) {
              validationErrors.push('âŒ å¿…é¡»é€‰æ‹© PR ç±»å‹ï¼ˆåªèƒ½é€‰æ‹©ä¸€ä¸ªï¼‰å‚è€ƒï¼šhttps://github.com/Geeker-Admin/Geeker-Admin/blob/main/commitlint.config.mjs#L31-L45');
            }

            // æ£€æŸ¥æ˜¯å¦å¡«å†™äº†æ”¹è¿›åŠŸèƒ½ç‚¹
            const hasImprovements = body.includes('### ä¸»è¦æ”¹è¿›') && 
              body.includes('- ') && 
              !body.includes('### ä¸»è¦æ”¹è¿›\n- ');
            if (!hasImprovements) {
              validationErrors.push('âŒ å¿…é¡»å¡«å†™æ”¹è¿›åŠŸèƒ½ç‚¹');
            }

            // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†æ£€æŸ¥æ¸…å•
            const hasChecklist = body.includes('## ğŸ“‹ æ£€æŸ¥æ¸…å•') && 
              body.includes('- [x]') && 
              body.includes('æˆ‘çš„æäº¤ä¿¡æ¯éµå¾ªäº† [Conventional Commits]') &&
              body.includes('æˆ‘çš„ PR åªåŒ…å«ä¸€ä¸ª commit') &&
              body.includes('æˆ‘ä½¿ç”¨äº† rebase è€Œä¸æ˜¯ merge');
            if (!hasChecklist) {
              validationErrors.push('âŒ å¿…é¡»å®Œæˆæ£€æŸ¥æ¸…å•');
            }

            if (validationErrors.length > 0) {
              // æ·»åŠ æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['invalid', 'needs-info']
              });
              
              // æ·»åŠ è¯„è®º
              const commentBody = `âš ï¸ **PR æ ¼å¼ä¸ç¬¦åˆè¦æ±‚**\n\n${validationErrors.join('\n\n')}\n\n### ğŸ“‹ è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å®Œå–„ä½ çš„ PRï¼š\n\n1. **å…³è” Issue**ï¼šåœ¨ PR æè¿°ä¸­å…³è”ç›¸å…³ issueï¼ˆæ ¼å¼ï¼š#issue_numberï¼‰\n2. **å•ä¸€ Commit**ï¼šç¡®ä¿ PR åªåŒ…å«ä¸€ä¸ª commitï¼Œä½¿ç”¨ rebase åˆå¹¶å¤šä¸ª commit\n3. **é€‰æ‹©ç±»å‹**ï¼šé€‰æ‹©æ­£ç¡®çš„ PR ç±»å‹ï¼ˆåªèƒ½é€‰æ‹©ä¸€ä¸ªï¼‰\n4. **å¡«å†™æ”¹è¿›ç‚¹**ï¼šè¯¦ç»†æè¿°æœ¬æ¬¡ PR çš„æ”¹è¿›åŠŸèƒ½ç‚¹\n5. **å®Œæˆæ£€æŸ¥æ¸…å•**ï¼šç¡®ä¿æ‰€æœ‰æ£€æŸ¥é¡¹éƒ½å·²å®Œæˆ\n\n### âš ï¸ é‡è¦æé†’\n- ä¸ç¬¦åˆæ ¼å¼è¦æ±‚çš„ PR å°†è¢«æ ‡è®°ä¸º invalid\n- è¯·ä½¿ç”¨æä¾›çš„æ¨¡æ¿åˆ›å»º PR\n\nè¯·å®Œå–„ä¿¡æ¯åé‡æ–°æäº¤ï¼Œè°¢è°¢ï¼`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody
              });
              
              core.setFailed('PR format validation failed');
            } else {
              // ç§»é™¤ invalid æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: 'invalid'
                });
              } catch (e) {
                // æ ‡ç­¾ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
              }
            }
